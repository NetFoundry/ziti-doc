import LoggingSnippetMd from './_logging-snippet.md'

# Deploying Router

## Components of Deployment:
1. Identity
    The pki-related fields in the `identity` section of the router configuration files are important to understand. These
    files are generated during the process of [enrolling](#enrollment) the edge router. These files do not need to exist before enrollment 
    and will be created during the
    enrollment process. This means the process running the enrollment will need the correct privileges granted in order
    to write - or overwrite those files incae of re-enrollment.  If the key specified in the identity section already exists - it will not be
    overwritten. Instead, it will be used during the enrollment process.
1. Configuration File
    The Edge Router is configured using a [yaml](https://yaml.org/) file. The configuration file can be obtained
    by running the `ziti` CLI tool on the destiantion host, but some configration options will need to be passeed to match teh deplyment hostname and/or 
    ip. See `Process of deployment` for more details

## Sizing Guidelines

The sizing guide is located at [Router-VM-Sizing-Guide] (https://support.netfoundry.io/hc/en-us/articles/360025875331-Edge-Router-VM-Sizing-Guide)

## Process of deployment
1. Download ziti and ziti-router binaries 
1. Set environmental variables that match your deployment
```
//export ZITI_CONTROLLER_HOSTNAME=
//export ZITI_EDGE_CONTROLLER_HOSTNAME=
//export ZITI_EDGE_CONTROLLER_PORT=80
//export ZITI_EDGE_CONTROLLER_API=
//export ZTI_EDGE_CTRL_ADVERTISED_HOST_PORT=
//export ZITI_EDGE_ROUTER_IP_OVERRIDE=
//export ZITI_EDGE_ROUTER_HOSTNAME=
export ZITI_EDGE_ROUTER_PORT=
```
1. Create router config file
    ```bash
    ziti create config router edge --routerName demorouter01 --wss --output edgeconfig.yml
    ```
    Configuration Details
    ```yaml
    v: 3
    identity:
    cert:                 "/demorouter01.cert"
    server_cert:          "/demorouter01.server.chain.cert"
    key:                  "/demorouter01.key"
    ca:                   "/demorouter01.cas"

    ctrl:
    endpoint:             tls:ip-10-40-101-194:6262

    link:
    dialers:
        - binding: transport
    listeners:
        - binding:          transport
        bind:             tls:0.0.0.0:10080
        advertise:        tls:ip-10-40-101-194:10080
        options:
            outQueueSize:   4

    listeners:
    # bindings of edge and tunnel requires an "edge" section below
    - binding: edge
        address: ws:0.0.0.0:3022
        options:
        advertise: ip-10-40-101-194:3023
        connectTimeoutMs: 1000
        getSessionTimeout: 60s
    - binding: tunnel
        options:
        mode: host #tproxy|host


    edge:
    csr:
        country: US
        province: NC
        locality: Charlotte
        organization: NetFoundry
        organizationalUnit: Ziti
        sans:
        dns:
            - ip-10-40-101-194
            - localhost
        ip:
            - "127.0.0.1"

    transport:
    ws:
        writeTimeout: 10
        readTimeout: 5
        idleTimeout: 5
        pongTimeout: 60
        pingInterval: 54
        handshakeTimeout: 10
        readBufferSize: 4096
        writeBufferSize: 4096
        enableCompression: true
        server_cert: /demorouter01.server.chain.cert
        key: /demorouter01.key

    forwarder:
    latencyProbeInterval: 10
    xgressDialQueueLength: 1000
    xgressDialWorkerCount: 128
    linkDialQueueLength: 1000
    ```
1. Creation of router in the controller db
    ```bash
    ziti edge create edge-router [router name] -o [path to jwt] -t --no-traversal 
    ```

    ```json
    v: 3
    ## files generated during enrollment and saved in these paths
    identity:
    cert:                 "./router.cert"
    server_cert:          "./router.server.chain.cert"
    key:                  "./router.key"
    ca:                   "./router.ca"
    ## fabric section
    ctrl:
    endpoint:             tls:${ZITI_CONTROLLER}:6262
    link:
    dialers:
        - binding: transport
    listeners:
    - binding: edge
        address: tls:0.0.0.0:8442
        options:
        advertise: ${EXTERNAL_DNS}:8442
        connectTimeoutMs: 1000
        getSessionTimeout: 60s
    - binding: tunnel
        options:
        lanIf: eth0
        resolver: udp://${EXTERNAL_DNS}:53
    edge:
    csr:
        country: US
        province: NC
        locality: Charlotte
        organization: NetFoundry
        organizationalUnit: Ziti
        sans:
        dns:
            - localhost
        ip:
            - 127.0.0.1
            - ${adapter_ip}
    ## addititonal configuration options
    web:
    - apis:
    ## router health check binding port, where external resources can use to query for latest status of the router process.
        - binding: health-checks
        bindPoints:
        - address: 0.0.0.0:8081
        interface: 0.0.0.0:8081
        name: health-check
    ```
1. Enrolling router to create identity files
    ```bash
    ziti-router enroll [path to configuration file] --jwt [path to jwt]
    ```
