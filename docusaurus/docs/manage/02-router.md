---
id: deploying-router
title: Deploying Router
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import styles from './styles.module.css';

# Deploying Router
In this article, we are describing the process of router deployment and what attributes can be updated, removed, added after the deployment is completed.  

:::info Notes
Currently, the DNS name or IP address can not be changed after the deployment, because it requires to update the sans section of the router server certificate. To do that on would need to re-enroll the router, which can not be done without creating a new router.
:::

## Components of Deployment:

<Tabs>
<TabItem value="Identity" label="Identity" attributes={{className: styles.green}}>

The pki-related fields in the `identity` section of the router configuration files are important to understand. These
files are generated during the process of [enrolling](#enrollment) the router. These files do not need to exist before and will be created during the enrollment process. 
This means the process running the enrollment will need the correct privileges granted in order to write - or overwrite those files in case of re-enrollment.  
If the key specified in the identity section already exists - it will not be overwritten. Instead, it will be used during the enrollment process. In other words, you can create
your own key or use existing key.

</TabItem>
<TabItem value="Config" label="Configuration File" attributes={{className: styles.blue}}>

The router is configured using a [yaml](https://yaml.org/) file. The configuration file can be obtained by running the `ziti` CLI binary on the destiantion host, 
but some configration options will need to be passeed to match the deployment details, i.e hostname, ip, private or public routers, etc. See `Process of deployment` for more .

</TabItem>
</Tabs>

## Sizing Guidelines

The sizing guide is located at [Router-VM-Sizing-Guide] (https://support.netfoundry.io/hc/en-us/articles/360025875331-Edge-Router-VM-Sizing-Guide)

## Process of deployment
The recommended way of deploying a router is to run through these steps on the host that will be hosting the router. The router identity certificates will be created during the process, so it is more secure if they are downloaded to the host VM direct.

1. ##### Download ziti and ziti-router binaries to the host VM

1. ##### Create router config file {#router-config-file}

    :::info Notes
    Commented out options with `#` tag are generated by the template but not used for the described deployment. The router ip address is used in the private router option, 
    wheres the dns name is used in the public router. This is only to illustrate how either type can be used as an option for any deployment type.
    :::
 
    <Tabs groupId="routerType">
    <TabItem value="Private" label="Private Router with Edge" attributes={{className: styles.blue}}>

    This is a network dialing only router with edge. It does not listen for connections from other routers. Set environmental variables that match your deployment 
    and run the following command to create the router configuration file on the host VM.
    ```bash
    ZITI_CTRL_ADVERTISED_ADDRESS=controller01.zitinetwork.example.org
    ZITI_CTRL_PORT=80
    ZITI_ROUTER_ADVERTISED_HOST=192.168.10.11
    ZITI_EDGE_ROUTER_IP_OVERRIDE=192.168.10.11
    ZITI_EDGE_ROUTER_PORT=443
    ROUTER_NAME_PREFIX=$ZITI_ROUTER_ADVERTISED_HOST
    
    ./ziti create config router edge --routerName  $ROUTER_NAME_PREFIX \
                                    --output $ROUTER_NAME_PREFIX.yaml \
                                    --disableTunneler --private
    ```
    **Configuration Details after creation**
    ```yaml
    v: 3

    identity:
        cert:                 "/192.168.10.11.cert"
        server_cert:          "/192.168.10.11.server.chain.cert"
        key:                  "/192.168.10.11.key"
        ca:                   "/192.168.10.11.cas"

    ctrl:
        endpoint:             tls:controller01.zitinetwork.example.org:80

    link:
        dialers:
            - binding: transport
    #  listeners:
    #    - binding:          transport
    #      bind:             tls:0.0.0.0:10080
    #      advertise:        tls:192.168.10.11:10080
    #      options:
    #        outQueueSize:   4

    listeners:
    # bindings of edge and tunnel requires an "edge" section below
      - binding: edge
        address: tls:0.0.0.0:443
        options:
            advertise: 192.168.10.11:443
            connectTimeoutMs: 1000
            getSessionTimeout: 60
    #  - binding: tunnel
    #    options:
    #
    #
    #

    edge:
        csr:
            country: US
            province: NC
            locality: Charlotte
            organization: NetFoundry
            organizationalUnit: Ziti
            sans:
                dns:
                    - Windows-Workstation
                    - localhost
                ip:
                    - "127.0.0.1"
                    - "192.168.10.11"

    #transport:
    #  ws:
    #    writeTimeout: 10
    #    readTimeout: 5
    #    idleTimeout: 5
    #    pongTimeout: 60
    #    pingInterval: 54
    #    handshakeTimeout: 10
    #    readBufferSize: 4096
    #    writeBufferSize: 4096
    #    enableCompression: true
    #    server_cert: /192.168.10.11.server.chain.cert
    #    key: /192.168.10.11.key

    forwarder:
        latencyProbeInterval: 10
        xgressDialQueueLength: 1000
        xgressDialWorkerCount: 128
        linkDialQueueLength: 1000
        linkDialWorkerCount: 32
    ```

    </TabItem>
    <TabItem value="Gateway" label="Private Router with Edge and Tunneler" attributes={{className: styles.orange}}>

    This is a network dialing only router with edge and tunneler( i.e. gateway mode). It does not listen for connections from other routers. 
    Set environmental variables that match your deployment and run the following command to create the router configuration file on the host VM.
    ```bash
    ZITI_CTRL_ADVERTISED_ADDRESS=controller01.zitinetwork.example.org
    ZITI_CTRL_PORT=80
    ZITI_ROUTER_ADVERTISED_HOST=192.168.10.11
    ZITI_EDGE_ROUTER_IP_OVERRIDE=192.168.10.11
    ZITI_EDGE_ROUTER_PORT=443
    ZITI_EDGE_ROUTER_LAN_INTERFACE=eth0
    ROUTER_NAME_PREFIX=$ZITI_ROUTER_ADVERTISED_HOST

    ./ziti create config router edge --routerName  $ROUTER_NAME_PREFIX \
                                    --output $ROUTER_NAME_PREFIX.yaml \
                                    --Tproxy --private
    ```
    **Configuration Details after creation**
    ```yaml
    v: 3

    identity:
        cert:                 "/192.168.10.11.cert"
        server_cert:          "/192.168.10.11.server.chain.cert"
        key:                  "/192.168.10.11.key"
        ca:                   "/192.168.10.11.cas"

    ctrl:
        endpoint:             tls:controller01.zitinetwork.example.org:80

    link:
        dialers:
            - binding: transport
    #  listeners:
    #    - binding:          transport
    #      bind:             tls:0.0.0.0:10080
    #      advertise:        tls:192.168.10.11:10080
    #      options:
    #        outQueueSize:   4

    listeners:
    # bindings of edge and tunnel requires an "edge" section below
      - binding: edge
        address: tls:0.0.0.0:443
        options:
            advertise: 192.168.10.11:443
            connectTimeoutMs: 1000
            getSessionTimeout: 60
      - binding: tunnel
        options:
            mode: tproxy
            resolver: udp://192.168.10.11:53
            lanIf: eth0

    edge:
        csr:
            country: US
            province: NC
            locality: Charlotte
            organization: NetFoundry
            organizationalUnit: Ziti
            sans:
                dns:
                    - Dariusz-Workstation
                    - localhost
                ip:
                    - "127.0.0.1"
                    - "192.168.10.11"

    #transport:
    #  ws:
    #    writeTimeout: 10
    #    readTimeout: 5
    #    idleTimeout: 5
    #    pongTimeout: 60
    #    pingInterval: 54
    #    handshakeTimeout: 10
    #    readBufferSize: 4096
    #    writeBufferSize: 4096
    #    enableCompression: true
    #    server_cert: /192.168.10.11.server.chain.cert
    #    key: /192.168.10.11.key

    forwarder:
        latencyProbeInterval: 10
        xgressDialQueueLength: 1000
        xgressDialWorkerCount: 128
        linkDialQueueLength: 1000
        linkDialWorkerCount: 32
    ```

    </TabItem>
    <TabItem value="Public" label="Public Router with Edge" attributes={{className: styles.green}}>

    This is a network dialing and listening router with edge. It listens for connections from other routers. The host firewall needs to be opened to allow connections through. 
    In this example code, the ports are 80 and 443. Set environmental variables that match your deployment and run the following command to create the router configuration file on the host VM. 
    ```bash
    ZITI_CTRL_ADVERTISED_ADDRESS=controller01.zitinetwork.example.org
    ZITI_CTRL_PORT=80
    ZITI_EDGE_ROUTER_RAWNAME=router01.zitinetwork.example.org
    ZITI_EDGE_ROUTER_PORT=443
    ROUTER_NAME_PREFIX=$ZITI_EDGE_ROUTER_RAWNAME

    ./ziti create config router edge --routerName  $ROUTER_NAME_PREFIX \
                                    --output $ROUTER_NAME_PREFIX.yaml \
                                    --disableTunneler
    ```
    **Configuration Details after creation**
    ```yaml
    v: 3

    identity:
        cert:                 "/router01.zitinetwork.example.org.cert"
        server_cert:          "/router01.zitinetwork.example.org.server.chain.cert"
        key:                  "/router01.zitinetwork.example.org.key"
        ca:                   "/router01.zitinetwork.example.org.cas"

    ctrl:
        endpoint:             tls:controller01.zitinetwork.example.org:80

    link:
        dialers:
          - binding: transport
        listeners:
          - binding:          transport
            bind:             tls:0.0.0.0:10080
            advertise:        tls:router01.zitinetwork.example.org:10080
            options:
                outQueueSize:   4

    listeners:
    # bindings of edge and tunnel requires an "edge" section below
      - binding: edge
        address: tls:0.0.0.0:443
        options:
            advertise: router01.zitinetwork.example.org:443
            connectTimeoutMs: 1000
            getSessionTimeout: 60
    #  - binding: tunnel
    #    options:
    #
    #
    #

    edge:
        csr:
            country: US
            province: NC
            locality: Charlotte
            organization: NetFoundry
            organizationalUnit: Ziti
            sans:
                dns:
                    - router01.zitinetwork.example.org
                    - localhost
                ip:
                    - "127.0.0.1"

    #transport:
    #  ws:
    #    writeTimeout: 10
    #    readTimeout: 5
    #    idleTimeout: 5
    #    pongTimeout: 60
    #    pingInterval: 54
    #    handshakeTimeout: 10
    #    readBufferSize: 4096
    #    writeBufferSize: 4096
    #    enableCompression: true
    #    server_cert: /router01.zitinetwork.example.org.server.chain.cert
    #    key: /router01.zitinetwork.example.org.key

    forwarder:
        latencyProbeInterval: 10
        xgressDialQueueLength: 1000
        xgressDialWorkerCount: 128
        linkDialQueueLength: 1000
        linkDialWorkerCount: 32
    ```

    </TabItem>
    </Tabs>

1. ##### Controller login {#controller-login}

    You will need to log into the controller for the next couple of steps. 
    ```bash
    ziti edge login ${ZITI_CTRL_ADVERTISED_ADDRESS}:${ZITI_CONTROLLER_MGMT_PORT} \
                    -u admin -p ${ZITI_PASSWORD} -y
    ```

1. ##### Creation of router in the controller db {#router-create}

    <Tabs groupId="routerType">
    <TabItem value="Private" label="Private Router with Edge" attributes={{className: styles.blue}}>

    ```bash
    ziti edge create edge-router $ROUTER_NAME_PREFIX /
                                --jwt-output-file $ROUTER_NAME_PREFIX.jwt
    ```

    </TabItem>
    <TabItem value="Gateway" label="Private Router with Edge and Tunneler" attributes={{className: styles.orange}}>

    :::info Notes
    `--no-travesal` flag is not required, but keep in mind that private routers are stub routers and setting it to true disables transitive routing through it.
    In other words, only connections destined for this router will be routed to it by the samrt routing algorithm. `--tunneler-enabled or just -t` flag indicates the tunnel mode.
    :::

    ```bash
    ziti edge create edge-router $ROUTER_NAME_PREFIX \
                                --jwt-output-file $ROUTER_NAME_PREFIX.jwt \
                                --tunneler-enabled --no-traversal 
    ```

    </TabItem>
    <TabItem value="Public" label="Public Router with Edge" attributes={{className: styles.green}}>

    ```bash
    ziti edge create edge-router $ROUTER_NAME_PREFIX \
                                --jwt-output-file $ROUTER_NAME_PREFIX.jwt
    ```

    </TabItem>
    </Tabs>

1. ##### Enrolling router to create identity files {#enrollment}
    
    ```bash
    ziti-router enroll $ROUTER_NAME_PREFIX.yaml \
                    --jwt $ROUTER_NAME_PREFIX.jwt
    ```
1. ##### Updating a router after deployment {#router-update}